(function(i,d){typeof exports=="object"&&typeof module<"u"?module.exports=d(require("leaflet")):typeof define=="function"&&define.amd?define(["leaflet"],d):(i=typeof globalThis<"u"?globalThis:i||self,i["leaflet-path-drag"]=d(i.L))})(this,function(i){"use strict";i.SVG.include({_resetTransformPath:function(t){t._path.setAttributeNS(null,"transform","")},transformPath:function(t,o){t._path.setAttributeNS(null,"transform","matrix("+o.join(" ")+")")}}),i.SVG.include(i.Browser.vml?{_resetTransformPath:function(t){t._skew&&(t._skew.on=!1,t._path.removeChild(t._skew),t._skew=null)},transformPath:function(t,o){let n=t._skew;n||(n=i.SVG.create("skew"),t._path.appendChild(n),n.style.behavior="url(#default#VML)",t._skew=n);const s=o[0].toFixed(8)+" "+o[1].toFixed(8)+" "+o[2].toFixed(8)+" "+o[3].toFixed(8)+" 0 0",e=Math.floor(o[4]).toFixed()+", "+Math.floor(o[5]).toFixed(),a=this._path.style;let r=parseFloat(a.left),h=parseFloat(a.top),_=parseFloat(a.width),c=parseFloat(a.height);isNaN(r)&&(r=0),isNaN(h)&&(h=0),(isNaN(_)||!_)&&(_=1),(isNaN(c)||!c)&&(c=1);const f=(-r/_-.5).toFixed(8)+" "+(-h/c-.5).toFixed(8);n.on="f",n.matrix=s,n.origin=f,n.offset=e,n.on=!0}}:{});function d(){return!0}i.Canvas.include({_resetTransformPath:function(t){this._containerCopy&&(delete this._containerCopy,t._containsPoint_&&(t._containsPoint=t._containsPoint_,delete t._containsPoint_,this._requestRedraw(t)))},transformPath:function(t,o){let n=this._containerCopy;const s=this._ctx;let e;const a=i.Browser.retina?2:1,r=this._bounds,h=r.getSize(),_=r.min;n||(n=this._containerCopy=document.createElement("canvas"),e=n.getContext("2d"),n.width=a*h.x,n.height=a*h.y,this._removePath(t),this._redraw(),e.translate(a*r.min.x,a*r.min.y),e.drawImage(this._container,0,0),this._initPath(t),t._containsPoint_=t._containsPoint,t._containsPoint=d),s.save(),s.clearRect(_.x,_.y,h.x*a,h.y*a),s.setTransform(1,0,0,1,0,0),s.restore(),s.save(),s.drawImage(this._containerCopy,0,0,h.x,h.y),s.transform.apply(s,o),this._drawing=!0,t._updatePath(),this._drawing=!1,s.restore()}});/**
 * Leaflet vector features drag functionality
 * @author Alexander Milevski <info@w8r.name>
 * @preserve
 */i.Path.include({_transform:function(t){return this._renderer&&(t?this._renderer.transformPath(this,t):(this._renderer._resetTransformPath(this),this._update())),this},_onMouseClick:function(t){this.dragging&&this.dragging.moved()||this._map.dragging&&this._map.dragging.moved()||this._fireMouseEvent(t)}});const P={mousedown:"mouseup",touchstart:"touchend",pointerdown:"touchend",MSPointerDown:"touchend"},D={mousedown:"mousemove",touchstart:"touchmove",pointerdown:"touchmove",MSPointerDown:"touchmove"};function v(t,o){const n=t.x-o.x,s=t.y-o.y;return Math.sqrt(n*n+s*s)}return i.Handler.PathDrag=i.Handler.extend({statics:{DRAGGING_CLS:"leaflet-path-draggable"},initialize:function(t){this._path=t,this._matrix=null,this._startPoint=null,this._dragStartPoint=null,this._mapDraggingWasEnabled=!1,this._path._dragMoved=!1},addHooks:function(){this._path.on("mousedown",this._onDragStart,this),this._path.options.className=this._path.options.className?this._path.options.className+" "+i.Handler.PathDrag.DRAGGING_CLS:i.Handler.PathDrag.DRAGGING_CLS,this._path._path&&i.DomUtil.addClass(this._path._path,i.Handler.PathDrag.DRAGGING_CLS)},removeHooks:function(){this._path.off("mousedown",this._onDragStart,this),this._path.options.className=this._path.options.className.replace(new RegExp("\\s+"+i.Handler.PathDrag.DRAGGING_CLS),""),this._path._path&&i.DomUtil.removeClass(this._path._path,i.Handler.PathDrag.DRAGGING_CLS)},moved:function(){return this._path._dragMoved},_onDragStart:function(t){const o=t.originalEvent._simulated?"touchstart":t.originalEvent.type;console.log({eventType:o}),this._mapDraggingWasEnabled=!1,this._startPoint=t.containerPoint.clone(),this._dragStartPoint=t.containerPoint.clone(),this._matrix=[1,0,0,1,0,0],i.DomEvent.stop(t.originalEvent),i.DomUtil.addClass(this._path._renderer._container,"leaflet-interactive"),i.DomEvent.on(document,D[o],this._onDrag,this).on(document,P[o],this._onDragEnd,this),this._path._map.dragging.enabled()&&(this._path._map.dragging.disable(),this._mapDraggingWasEnabled=!0),this._path._dragMoved=!1,this._path._popup&&this._path._popup.close(),this._replaceCoordGetters(t)},_onDrag:function(t){i.DomEvent.stop(t);const o=t.touches&&t.touches.length>=1?t.touches[0]:t,n=this._path._map.mouseEventToContainerPoint(o);if(t.type==="touchmove"&&!this._path._dragMoved&&this._dragStartPoint.distanceTo(n)<=this._path._map.options.tapTolerance)return;const s=n.x,e=n.y,a=s-this._startPoint.x,r=e-this._startPoint.y;(a||r)&&(this._path._dragMoved||(this._path._dragMoved=!0,this._path.options.interactive=!1,this._path._map.dragging._draggable._moved=!0,this._path.fire("dragstart",t),this._path.bringToFront()),this._matrix[4]=a,this._matrix[5]=r,this._startPoint.x=s,this._startPoint.y=e,this._path.fire("predrag",t),this._transformPoints(this._matrix),this._path._updatePath(),this._path._project(),this._path._transform(null),this._path.fire("drag",t))},_onDragEnd:function(t){const o=this._path._map.mouseEventToContainerPoint(t),n=this.moved();if(console.log("moved",n),i.DomEvent.off(document,"mousemove touchmove",this._onDrag,this),i.DomEvent.off(document,"mouseup touchend",this._onDragEnd,this),this._restoreCoordGetters(),n){this._path.fire("dragend",{distance:v(this._dragStartPoint,o)});const s=this._path._containsPoint;this._path._containsPoint=i.Util.falseFn,i.Util.requestAnimFrame(function(){this._path._dragMoved=!1,this._path.options.interactive=!0,this._path._containsPoint=s},this)}this._mapDraggingWasEnabled&&this._path._map.dragging.enable()},_transformPoints:function(t,o){const n=this._path,s=L.point(t[4],t[5]),e=n._map.options.crs,a=e.transformation,r=e.scale(n._map.getZoom());n._map.getZoom();const h=e.projection,_=a.untransform(s,r).subtract(a.untransform(i.point(0,0),r)),c=!o;if(n._bounds=new i.LatLngBounds,n._point)o=h.unproject(h.project(n._latlng)._add(_)),c&&(n._latlng=o,n._point._add(s));else if(n._rings||n._parts){const f=n._rings||n._parts;let p=n._latlngs;o=o||p,i.Util.isArray(p[0])||(p=[p],o=[o]);const m=this._calculateLatLngOffset(n._map,s,p);for(let g=0,x=f.length;g<x;g++){o[g]=o[g]||[];for(let u=0,w=f[g].length;u<w;u++){const l=p[g][u];o[g][u].lat=l.lat+m.lat,o[g][u].lng=l.lng+m.lng}}}return o},_calculateLatLngOffset:function(t,o,n){const s=n[0][0];console.log("pointCoordinates",s);const e=t.latLngToLayerPoint(s);console.log("pointProjectedOnMapPixels",e),e.x+=o.x,e.y+=o.y;const a=t.layerPointToLatLng(e);console.log("pointCoordinatesAfterMove",a);const r={lat:a.lat-s.lat,lng:a.lng-s.lng};return console.log("latLngOffset",r),r},_replaceCoordGetters:function(){this._path.getLatLng?(this._path.getLatLng_=this._path.getLatLng,this._path.getLatLng=i.Util.bind(function(){return this.dragging._transformPoints(this.dragging._matrix,{})},this._path)):this._path.getLatLngs&&(this._path.getLatLngs_=this._path.getLatLngs,this._path.getLatLngs=i.Util.bind(function(){return this.dragging._transformPoints(this.dragging._matrix,[])},this._path))},_restoreCoordGetters:function(){this._path.getLatLng_?(this._path.getLatLng=this._path.getLatLng_,delete this._path.getLatLng_):this._path.getLatLngs_&&(this._path.getLatLngs=this._path.getLatLngs_,delete this._path.getLatLngs_)}}),i.Handler.PathDrag.makeDraggable=function(t){return t.dragging=new i.Handler.PathDrag(t),t},i.Path.prototype.makeDraggable=function(){return i.Handler.PathDrag.makeDraggable(this)},i.Path.addInitHook(function(){this.options.draggable?(this.options.interactive=!0,this.dragging?this.dragging.enable():(i.Handler.PathDrag.makeDraggable(this),this.dragging.enable())):this.dragging&&this.dragging.disable()}),i.Handler.PathDrag});
