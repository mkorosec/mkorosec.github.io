<!DOCTYPE html>
<html>
<head>
    <title>Interactive Map with Draggable Objects</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Leaflet Path Drag Plugin -->
    <script src="https://unpkg.com/leaflet-path-drag@1.9.5/dist/index.js"></script>
    <!-- Proj4js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
    <!-- Proj4Leaflet -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4leaflet/1.0.2/proj4leaflet.js"></script>
    <script>
        // Initialize the map
        var map = L.map('map').setView([20, 0], 2); // Centered at latitude 20, longitude 0, zoom level 2

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);
        
        // Function to split MultiPolygon into Polygons
        function splitMultiPolygon(geojson) {
            var features = [];
            if (geojson.geometry.type === "MultiPolygon") {
                geojson.geometry.coordinates.forEach(function(polygonCoords) {
                    var polygon = {
                        "type": "Feature",
                        "properties": geojson.properties,
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": polygonCoords
                        }
                    };
                    features.push(polygon);
                });
            } else if (geojson.geometry.type === "Polygon") {
                features.push(geojson);
            }
            return features;
        }


        proj4.defs("urn:ogc:def:crs:EPSG::26915", "+proj=utm +zone=15 +ellps=GRS80 +datum=NAD83 +units=m +no_defs");


        // Function to add draggable GeoJSON Polygon to the map
        function addDraggablePolygon(geojson) {
            // Transform GeoJSON coordinates from EPSG:4326 to EPSG:3857    
            var transformedGeoJSON = transformGeoJSON(geojson, sourceProj, destProj);

            console.log('Original:', geojson);
            console.log('Transformed:', transformedGeoJSON);
            
            var transformedGeoJSON = transformGeoJSON(geojson, proj4.defs('WGS84'), proj4.defs('EPSG:3857'));
            transformedGeoJSON.crs={name:'EPSG:3857'}

            L.geoJSON(transformedGeoJSON, {
                style: {
                    color: 'green',
                    weight: 2,
                    fillOpacity: 0.2
                }
            }).addTo(map);

            L.geoJSON(transformGeoJSON(geojson, proj4.defs('WGS84'), proj4.defs('EPSG:53042')), {
                style: {
                    color: 'purple',
                    weight: 2,
                    fillOpacity: 0.2
                }
            }).addTo(map);


            

            var layer = L.geoJSON(geojson, {
                style: {
                    color: 'blue',
                    weight: 2,
                    fillOpacity: 0.2
                }
            }).addTo(map);

            // Enable dragging
            layer.eachLayer(function(l) {
                if (l.dragging) {
                    l.dragging.enable();
                } else {
                    l.dragging = new L.Handler.PathDrag(l);
                    l.dragging.enable();
                }

                // Optional: Handle drag events
                l.on('dragend', function () {
                    var newCoords = l.getLatLngs();
                    console.log(geojson.properties.name + ' moved to:', newCoords);
                });
            });
        }




        // Source projection (assuming GeoJSON is in EPSG:4326)
        var sourceProj = proj4.defs('EPSG:3857');

        // Destination projection (Leaflet uses EPSG:3857 by default)
        var destProj = proj4.defs('EPSG:3857');

        // Function to transform GeoJSON coordinates
        function transformGeoJSON(geojson, fromProj, toProj) {
            var transformed = JSON.parse(JSON.stringify(geojson)); // Deep copy
            function transformCoord(coord) {
                return proj4(fromProj, toProj, coord);
            }
            function traverseCoords(coords) {
                if (typeof coords[0] === 'number') {
                    return transformCoord(coords);
                } else {
                    return coords.map(traverseCoords);
                }
            }
            if (transformed.type === 'FeatureCollection') {
                transformed.features.forEach(function(feature) {
                    feature.geometry.coordinates = traverseCoords(feature.geometry.coordinates);
                });
            } else if (transformed.type === 'Feature') {
                transformed.geometry.coordinates = traverseCoords(transformed.geometry.coordinates);
            } else {
                transformed.coordinates = traverseCoords(transformed.coordinates);
            }

            return transformed;
        }


        // Load GeoJSON data (you can replace this with your own GeoJSON)
        // For demonstration, we'll use a sample country GeoJSON (e.g., France)
        fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries/RUS.geo.json')
            .then(function(response) {
                return response.json();
            })
            .then(function(geojson) {
                geojson.features.forEach(function(feature) {
                    var individualPolygons = splitMultiPolygon(feature);
                    individualPolygons.forEach(function(polygon) {
                        addDraggablePolygon(polygon);
                    });
                });                
            })
            .catch(function(error) {
                console.error('Error loading GeoJSON:', error);
            });








    </script>
</body>
</html>